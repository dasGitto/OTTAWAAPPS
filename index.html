<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FREEPILE Ottawa ¬∑ snap ¬∑ flick ¬∑ done</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f1f5f9;
            color: #0f172a;
            padding: 1rem;
            overflow-x: hidden;
            touch-action: pan-y pinch-zoom; /* Allow pinch zoom on body */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo span {
            background: #0f172a;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 40px;
            font-size: 1rem;
        }

        .region-badge {
            background: #e62e2e;
            color: white;
            padding: 0.25rem 1rem;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .region-badge::before {
            content: "üìç";
        }

        .handle-box {
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .handle-box input {
            border: none;
            padding: 0.5rem;
            font-size: 1rem;
            width: 150px;
            border-bottom: 2px solid #e2e8f0;
        }

        .handle-box input:focus {
            outline: none;
            border-bottom-color: #3b82f6;
        }

        .handle-box button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
        }

        .region-selector {
            background: white;
            border-radius: 40px;
            padding: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .region-btn {
            padding: 0.5rem 1.25rem;
            border-radius: 40px;
            border: none;
            background: transparent;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .region-btn.active {
            background: #e62e2e;
            color: white;
        }

        .region-btn.ottawa {
            font-weight: 700;
        }

        .upload-card {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .upload-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-title .badge {
            background: #f1f5f9;
            color: #475569;
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
            border-radius: 40px;
        }

        .upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
        }

        .upload-area:hover {
            border-color: #e62e2e;
            background: #fef2f2;
        }

        .upload-area .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-area .text {
            font-size: 1.25rem;
            font-weight: 500;
            color: #334155;
        }

        #fileInput {
            display: none;
        }

        .preview-section {
            margin-top: 2rem;
            display: none;
        }

        .preview-section.active {
            display: block;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 2rem;
            align-items: start;
        }

        .preview-image {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            border: 3px solid white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .ml-results {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 16px;
        }

        .ml-label {
            display: inline-block;
            background: #e62e2e;
            color: white;
            padding: 0.25rem 1rem;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .ml-field {
            margin-bottom: 1rem;
        }

        .ml-field label {
            font-weight: 600;
            color: #475569;
            display: block;
            margin-bottom: 0.25rem;
        }

        .ml-field input, .ml-field textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
        }

        .ml-field textarea {
            height: 80px;
            resize: vertical;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .tag {
            background: #e2e8f0;
            padding: 0.25rem 0.75rem;
            border-radius: 40px;
            font-size: 0.85rem;
            color: #334155;
        }

        .pile-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .pile-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .pile-btn.free {
            background: #dcfce7;
            color: #166534;
            border: 2px solid #86efac;
        }

        .pile-btn.free:hover {
            background: #bbf7d0;
            transform: translateY(-2px);
        }

        .pile-btn.sale {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #fecaca;
        }

        .pile-btn.sale:hover {
            background: #fecaca;
            transform: translateY(-2px);
        }

        .pile-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .pile-tab {
            padding: 0.75rem 2rem;
            font-size: 1.25rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 40px 40px 0 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pile-tab.active {
            background: #0f172a;
            color: white;
        }

        .pile-tab.free.active {
            background: #166534;
        }

        .pile-tab.sale.active {
            background: #991b1b;
        }

        .pile-tab .count {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 40px;
            font-size: 0.85rem;
        }

        /* Gesture-enabled cards grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
            touch-action: pan-y pinch-zoom; /* Allow pinch zoom on grid */
        }

        .card-container {
            position: relative;
            touch-action: none; /* Disable browser scrolling on card for gestures */
            user-select: none;
            -webkit-user-select: none;
            transform: translateZ(0); /* Force GPU acceleration */
            will-change: transform;
            z-index: 1;
            transition: transform 0.1s ease;
        }

        .card-container.zooming {
            transition: transform 0.05s ease;
            z-index: 100;
        }

        .card-container.panning {
            transition: none;
            z-index: 100;
        }

        .card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            position: relative;
            width: 100%;
            height: 100%;
            transform-origin: center center;
            transition: box-shadow 0.2s;
        }

        .card.free {
            border-left: 6px solid #22c55e;
        }

        .card.sale {
            border-left: 6px solid #ef4444;
        }

        .card.zoomed {
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }

        .card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #f1f5f9;
            pointer-events: none; /* Prevent image from stealing touches */
        }

        .card-content {
            padding: 1rem;
            pointer-events: none; /* Prevent content from stealing touches */
        }

        .card-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .card-price {
            font-weight: 700;
        }

        .card-price.free {
            color: #22c55e;
        }

        .card-price.sale {
            color: #ef4444;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            color: #64748b;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .card-region {
            background: #f1f5f9;
            padding: 0.25rem 0.75rem;
            border-radius: 40px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .ml-badge {
            background: #e2e8f0;
            padding: 0.25rem 0.75rem;
            border-radius: 40px;
            font-size: 0.7rem;
            display: inline-block;
            margin-top: 0.5rem;
        }

        /* Gesture hint overlays */
        .gesture-hint-left, .gesture-hint-right {
            position: absolute;
            top: 0;
            height: 100%;
            width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 5;
            border-radius: 16px;
        }

        .gesture-hint-left {
            left: 0;
            background: linear-gradient(90deg, #3b82f6 0%, transparent 100%);
            color: white;
            border-radius: 16px 0 0 16px;
        }

        .gesture-hint-right {
            right: 0;
            background: linear-gradient(270deg, #8b5cf6 0%, transparent 100%);
            color: white;
            border-radius: 0 16px 16px 0;
        }

        .gesture-hint-left.visible, .gesture-hint-right.visible {
            opacity: 1;
        }

        .gesture-hint-left.active {
            background: #2563eb;
            opacity: 1;
        }

        .gesture-hint-right.active {
            background: #7c3aed;
            opacity: 1;
        }

        /* Gesture action overlay */
        .gesture-action-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .gesture-action-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .gesture-action-modal {
            background: white;
            padding: 2rem;
            border-radius: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.2s;
        }

        .gesture-action-overlay.visible .gesture-action-modal {
            transform: translateY(0);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .modal-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            margin: 1rem 0;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
        }

        .modal-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .modal-btn.secondary {
            background: #e2e8f0;
            color: #334155;
        }

        .empty-state {
            text-align: center;
            padding: 4rem;
            color: #94a3b8;
            grid-column: 1 / -1;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top-color: #e62e2e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Saved items indicator */
        .saved-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #8b5cf6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 40px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                FREEPILE <span>alpha</span>
                <div class="region-badge">Ottawa ¬∑ your pile</div>
            </div>
            <div class="handle-box">
                <input type="text" id="handleInput" placeholder="your handle" maxlength="20">
                <button id="saveHandle">save</button>
            </div>
        </div>

        <!-- Mock Region Selector -->
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div class="region-selector">
                <button class="region-btn ottawa active" id="regionOttawa">üìç Ottawa</button>
                <button class="region-btn" id="regionMontreal">Montreal</button>
                <button class="region-btn" id="regionToronto">Toronto</button>
                <button class="region-btn" id="regionVancouver">Vancouver</button>
            </div>
            <div style="color: #64748b; font-size: 0.9rem;">
                <span id="currentRegionDisplay">üìç viewing Ottawa</span>
            </div>
        </div>

        <div class="upload-card">
            <div class="upload-title">
                üì∏ snap a photo
                <span class="badge">real ML ¬∑ one click ¬∑ ottawa only</span>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="icon">üì±</div>
                <div class="text" id="uploadText">tap to take photo or choose one</div>
                <div class="subtext">ML will identify it ¬∑ you can edit anything</div>
            </div>
            <input type="file" id="fileInput" accept="image/*" capture="environment">

            <div class="preview-section" id="previewSection">
                <div class="preview-grid">
                    <img id="previewImage" class="preview-image" src="" alt="preview">
                    
                    <div class="ml-results">
                        <div class="ml-label" id="mlStatus">ü§ñ ML analyzing...</div>
                        
                        <div class="ml-field">
                            <label>title</label>
                            <input type="text" id="mlTitle" placeholder="ML-generated title">
                        </div>
                        
                        <div class="ml-field">
                            <label>description</label>
                            <textarea id="mlDescription" placeholder="ML-generated description"></textarea>
                        </div>
                        
                        <div class="tag-list" id="tagList"></div>
                        
                        <div style="font-size:0.85rem; color:#64748b; margin:0.5rem 0;">
                            ‚úèÔ∏è you can edit anything ¬∑ ML is just guessing
                        </div>
                        
                        <div class="pile-buttons">
                            <button class="pile-btn free" id="dropFree">üÜì drop in FREE pile</button>
                            <button class="pile-btn sale" id="dropSale">üí∞ drop in FOR SALE pile</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="pile-nav">
            <div class="pile-tab free active" id="tabFree" data-pile="free">
                üÜì FREE pile <span class="count" id="freeCount">0</span>
            </div>
            <div class="pile-tab sale" id="tabSale" data-pile="sale">
                üí∞ FOR SALE pile <span class="count" id="saleCount">0</span>
            </div>
        </div>

        <!-- Cards grid with gesture support -->
        <div class="cards-grid" id="cardsGrid"></div>
    </div>

    <!-- Gesture action overlay -->
    <div class="gesture-action-overlay" id="gestureOverlay">
        <div class="gesture-action-modal" id="gestureModal">
            <div class="modal-title" id="modalTitle">Ask a question</div>
            <textarea id="modalMessage" class="modal-input" placeholder="Type your message..." rows="3"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="modalCancel">Cancel</button>
                <button class="modal-btn primary" id="modalConfirm">Send</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const HF_TOKEN = 'hf_YOUR_TOKEN_HERE'; // REPLACE WITH YOUR ACTUAL TOKEN
        const HOME_REGION = 'ottawa';
        
        // ==================== STATE ====================
        let currentHandle = localStorage.getItem('freepile_handle') || '';
        let deviceId = localStorage.getItem('freepile_device_id');
        if (!deviceId) {
            deviceId = 'device_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('freepile_device_id', deviceId);
        }

        let currentRegion = localStorage.getItem('freepile_current_region') || HOME_REGION;
        let listings = JSON.parse(localStorage.getItem('freepile_listings') || '[]');
        let savedItems = JSON.parse(localStorage.getItem('freepile_saved') || '[]');
        let currentPile = 'free';
        let currentMLResult = null;

        // Gesture state
        let activeCard = null;
        let activeCardElement = null;
        let startX = 0;
        let startY = 0;
        let startScale = 1;
        let currentScale = 1;
        let currentTranslateX = 0;
        let isPanning = false;
        let isPinching = false;
        let initialDistance = 0;
        let touchStartTime = 0;
        let gestureHintLeft, gestureHintRight;

        // ==================== INIT ====================
        document.getElementById('handleInput').value = currentHandle;
        if (currentHandle) {
            document.getElementById('saveHandle').textContent = '‚úì';
        }

        updateRegionDisplay();
        updateCounts();
        renderGrid();

        // ==================== REGION SELECTOR ====================
        document.getElementById('regionOttawa').addEventListener('click', () => setCurrentRegion('ottawa'));
        document.getElementById('regionMontreal').addEventListener('click', () => setCurrentRegion('montreal'));
        document.getElementById('regionToronto').addEventListener('click', () => setCurrentRegion('toronto'));
        document.getElementById('regionVancouver').addEventListener('click', () => setCurrentRegion('vancouver'));

        function setCurrentRegion(region) {
            currentRegion = region;
            localStorage.setItem('freepile_current_region', region);
            
            document.querySelectorAll('.region-btn').forEach(btn => btn.classList.remove('active'));
            if (region === 'ottawa') document.getElementById('regionOttawa').classList.add('active');
            else if (region === 'montreal') document.getElementById('regionMontreal').classList.add('active');
            else if (region === 'toronto') document.getElementById('regionToronto').classList.add('active');
            else if (region === 'vancouver') document.getElementById('regionVancouver').classList.add('active');
            
            updateRegionDisplay();
            renderGrid();
        }

        function updateRegionDisplay() {
            const display = document.getElementById('currentRegionDisplay');
            display.innerHTML = currentRegion === HOME_REGION 
                ? `üìç viewing <strong>Ottawa</strong> ¬∑ your home pile`
                : `üìç viewing <strong>${currentRegion}</strong> ¬∑ travel mode`;
        }

        // ==================== HANDLE ====================
        document.getElementById('saveHandle').addEventListener('click', () => {
            const handle = document.getElementById('handleInput').value.trim();
            if (handle && handle.match(/^[a-zA-Z0-9_]{3,20}$/)) {
                currentHandle = handle;
                localStorage.setItem('freepile_handle', handle);
                document.getElementById('saveHandle').textContent = '‚úì';
            } else {
                alert('handle must be 3-20 chars: letters, numbers, underscore');
            }
        });

        // ==================== UPLOAD ====================
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewSection = document.getElementById('previewSection');
        const previewImage = document.getElementById('previewImage');
        const mlTitle = document.getElementById('mlTitle');
        const mlDescription = document.getElementById('mlDescription');
        const tagList = document.getElementById('tagList');
        const mlStatus = document.getElementById('mlStatus');
        const uploadText = document.getElementById('uploadText');

        uploadArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => previewImage.src = e.target.result;
            reader.readAsDataURL(file);

            await runRealML(file);
        });

        // ==================== REAL ML ====================
        async function runRealML(file) {
            previewSection.classList.remove('active');
            uploadText.innerHTML = '<span class="loading-spinner"></span> ML thinking...';
            mlStatus.innerHTML = 'ü§ñ ML analyzing image...';
            
            try {
                const base64 = await fileToBase64(file);
                const imageData = base64.split(',')[1];
                
                const captionResponse = await fetch(
                    "https://api-inference.huggingface.co/models/nlpconnect/vit-gpt2-image-captioning",
                    {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${HF_TOKEN}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ inputs: imageData })
                    }
                );
                
                if (!captionResponse.ok) throw new Error(`Caption API error: ${captionResponse.status}`);
                const captionData = await captionResponse.json();
                
                const tagsResponse = await fetch(
                    "https://api-inference.huggingface.co/models/google/vit-base-patch16-224",
                    {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${HF_TOKEN}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ inputs: imageData })
                    }
                );
                
                if (!tagsResponse.ok) throw new Error(`Tags API error: ${tagsResponse.status}`);
                const tagsData = await tagsResponse.json();
                
                let title = "Item";
                let description = "";
                let tags = [];
                
                if (captionData && captionData[0] && captionData[0].generated_text) {
                    const caption = captionData[0].generated_text;
                    const words = caption.split(' ');
                    title = words.slice(0, 5).join(' ');
                    if (title.length < 3) title = caption.substring(0, 40);
                    description = caption;
                }
                
                if (tagsData && Array.isArray(tagsData)) {
                    tags = tagsData
                        .sort((a, b) => b.score - a.score)
                        .slice(0, 5)
                        .map(t => t.label);
                }
                
                mlTitle.value = title;
                mlDescription.value = description;
                tagList.innerHTML = tags.map(t => `<span class="tag">#${t.replace(/,/g, '').toLowerCase()}</span>`).join('');
                mlStatus.innerHTML = 'ü§ñ ML finished ‚Äî edit if needed';
                
                currentMLResult = { title, description, tags };
                
            } catch (error) {
                console.error('ML API error:', error);
                mlStatus.innerHTML = '‚ö†Ô∏è ML error ‚Äî using fallback';
                await runMockML(file);
            } finally {
                uploadText.innerHTML = 'tap to take photo or choose one';
                previewSection.classList.add('active');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function runMockML(file) {
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const fileName = file.name.toLowerCase();
            let title = '', description = '', tags = [];
            
            if (fileName.includes('camera') || fileName.includes('lens')) {
                title = 'Camera Lens'; description = 'Black camera lens, looks like 50mm'; tags = ['photography', 'camera', 'electronics'];
            } else if (fileName.includes('chair') || fileName.includes('sofa') || fileName.includes('couch')) {
                title = 'Comfortable Chair'; description = 'Wooden chair with cushion, seems in good condition'; tags = ['furniture', 'chair', 'home'];
            } else if (fileName.includes('book')) {
                title = 'Book'; description = 'Paperback book, looks like fiction'; tags = ['books', 'reading'];
            } else if (fileName.includes('shirt') || fileName.includes('pants') || fileName.includes('jacket')) {
                title = 'Clothing Item'; description = 'Apparel, appears gently used'; tags = ['clothing', 'fashion'];
            } else if (fileName.includes('phone')) {
                title = 'Smartphone'; description = 'Mobile phone with screen visible'; tags = ['electronics', 'phone'];
            } else if (fileName.includes('bike')) {
                title = 'Bicycle'; description = 'Bike, seems rideable'; tags = ['sports', 'outdoor', 'bike'];
            } else {
                title = 'Item (ML guessing)'; description = 'Could not identify clearly. Please edit.'; tags = ['misc'];
            }
            
            mlTitle.value = title;
            mlDescription.value = description;
            tagList.innerHTML = tags.map(t => `<span class="tag">#${t}</span>`).join('');
            currentMLResult = { title, description, tags };
        }

        // ==================== DROP INTO PILES ====================
        document.getElementById('dropFree').addEventListener('click', () => dropIntoPile('free'));
        document.getElementById('dropSale').addEventListener('click', () => {
            const price = prompt('Enter price (in $):', '20');
            if (price === null) return;
            const priceNum = parseFloat(price);
            if (isNaN(priceNum) || priceNum <= 0) {
                alert('please enter a valid price');
                return;
            }
            dropIntoPile('sale', priceNum);
        });

        function dropIntoPile(type, price = null) {
            if (!currentHandle) {
                alert('please set a handle first');
                return;
            }

            if (!previewImage.src || !mlTitle.value) {
                alert('take a photo first');
                return;
            }

            if (currentRegion !== HOME_REGION) {
                alert('you can only post in your home region (Ottawa)');
                return;
            }

            const listing = {
                id: 'listing_' + Date.now() + '_' + Math.random().toString(36).substring(2, 7),
                handle: currentHandle,
                type: type,
                title: mlTitle.value,
                description: mlDescription.value,
                tags: currentMLResult?.tags || [],
                price: type === 'sale' ? price : null,
                image: previewImage.src,
                mlGenerated: true,
                timestamp: Date.now(),
                region: HOME_REGION
            };

            listings.push(listing);
            localStorage.setItem('freepile_listings', JSON.stringify(listings));

            previewSection.classList.remove('active');
            fileInput.value = '';
            mlTitle.value = '';
            mlDescription.value = '';
            tagList.innerHTML = '';
            currentMLResult = null;
            
            updateCounts();
            renderGrid();
            
            alert(`‚úÖ dropped in ${type === 'free' ? 'FREE' : 'FOR SALE'} pile ¬∑ Ottawa`);
        }

        // ==================== PILE NAVIGATION ====================
        document.getElementById('tabFree').addEventListener('click', () => {
            currentPile = 'free';
            document.getElementById('tabFree').classList.add('active');
            document.getElementById('tabSale').classList.remove('active');
            renderGrid();
        });

        document.getElementById('tabSale').addEventListener('click', () => {
            currentPile = 'sale';
            document.getElementById('tabSale').classList.add('active');
            document.getElementById('tabFree').classList.remove('active');
            renderGrid();
        });

        // ==================== GESTURE HANDLING ====================
        function setupGestureHandlers() {
            const cards = document.querySelectorAll('.card-container');
            
            cards.forEach(card => {
                // Create gesture hint elements if they don't exist
                if (!card.querySelector('.gesture-hint-left')) {
                    const leftHint = document.createElement('div');
                    leftHint.className = 'gesture-hint-left';
                    leftHint.innerHTML = '‚Üê PING';
                    card.appendChild(leftHint);
                    
                    const rightHint = document.createElement('div');
                    rightHint.className = 'gesture-hint-right';
                    rightHint.innerHTML = 'SAVE ‚Üí';
                    card.appendChild(rightHint);
                }
                
                card.addEventListener('touchstart', handleTouchStart, { passive: false });
                card.addEventListener('touchmove', handleTouchMove, { passive: false });
                card.addEventListener('touchend', handleTouchEnd);
                card.addEventListener('touchcancel', handleTouchCancel);
                
                // Double-tap to reset zoom
                card.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    resetCardTransform(card);
                });
            });
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touches = e.touches;
            
            activeCard = this;
            activeCardElement = this;
            touchStartTime = Date.now();
            
            // Get current transform
            const transform = window.getComputedStyle(activeCardElement).transform;
            if (transform !== 'none') {
                const values = transform.split('(')[1].split(')')[0].split(',');
                currentTranslateX = parseFloat(values[4]) || 0;
                currentScale = parseFloat(values[0]) || 1;
            } else {
                currentTranslateX = 0;
                currentScale = 1;
            }
            
            if (touches.length === 2) {
                // Pinch gesture
                isPinching = true;
                activeCardElement.classList.add('zooming');
                const dx = touches[0].pageX - touches[1].pageX;
                const dy = touches[0].pageY - touches[1].pageY;
                initialDistance = Math.sqrt(dx * dx + dy * dy);
                startScale = currentScale;
            } else if (touches.length === 1) {
                // Pan gesture
                isPanning = true;
                activeCardElement.classList.add('panning');
                startX = touches[0].pageX - currentTranslateX;
                startY = touches[0].pageY;
                
                // Show gesture hints
                const leftHint = activeCardElement.querySelector('.gesture-hint-left');
                const rightHint = activeCardElement.querySelector('.gesture-hint-right');
                if (leftHint) leftHint.classList.add('visible');
                if (rightHint) rightHint.classList.add('visible');
            }
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!activeCardElement) return;
            
            const touches = e.touches;
            
            if (isPinching && touches.length === 2) {
                // Handle pinch zoom
                const dx = touches[0].pageX - touches[1].pageX;
                const dy = touches[0].pageY - touches[1].pageY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // Calculate new scale with constraints (0.5x to 3x)
                let newScale = startScale * (distance / initialDistance);
                newScale = Math.max(0.5, Math.min(3, newScale));
                
                // Apply transform
                activeCardElement.style.transform = `translateX(${currentTranslateX}px) scale(${newScale})`;
                
                // Highlight card when zoomed
                const card = activeCardElement.querySelector('.card');
                if (newScale > 1.2) {
                    card.classList.add('zoomed');
                } else {
                    card.classList.remove('zoomed');
                }
                
            } else if (isPanning && touches.length === 1) {
                // Handle horizontal pan
                const deltaX = touches[0].pageX - startX;
                
                // Constrain pan distance (max 150px in either direction)
                let newTranslateX = Math.max(-150, Math.min(150, deltaX));
                activeCardElement.style.transform = `translateX(${newTranslateX}px) scale(${currentScale})`;
                
                // Update hint highlights based on position
                const leftHint = activeCardElement.querySelector('.gesture-hint-left');
                const rightHint = activeCardElement.querySelector('.gesture-hint-right');
                
                if (leftHint && rightHint) {
                    if (newTranslateX < -50) {
                        leftHint.classList.add('active');
                        rightHint.classList.remove('active');
                    } else if (newTranslateX > 50) {
                        rightHint.classList.add('active');
                        leftHint.classList.remove('active');
                    } else {
                        leftHint.classList.remove('active');
                        rightHint.classList.remove('active');
                    }
                }
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            if (!activeCardElement) return;
            
            const touchDuration = Date.now() - touchStartTime;
            const isFlick = touchDuration < 300 && (Math.abs(currentTranslateX) > 30);
            
            if (isPanning) {
                // Get final position
                const transform = window.getComputedStyle(activeCardElement).transform;
                let finalTranslateX = 0;
                if (transform !== 'none') {
                    const values = transform.split('(')[1].split(')')[0].split(',');
                    finalTranslateX = parseFloat(values[4]) || 0;
                }
                
                // Determine action based on flick direction
                if (finalTranslateX < -80 || (isFlick && finalTranslateX < -30)) {
                    // Flicked left - ping seller
                    const listingId = activeCardElement.dataset.listingId;
                    showPingModal(listingId);
                    resetCardTransform(activeCardElement);
                } else if (finalTranslateX > 80 || (isFlick && finalTranslateX > 30)) {
                    // Flicked right - save for later
                    const listingId = activeCardElement.dataset.listingId;
                    saveForLater(listingId);
                    resetCardTransform(activeCardElement);
                } else {
                    // Not far enough - snap back
                    resetCardTransform(activeCardElement);
                }
                
                // Hide hints
                const leftHint = activeCardElement.querySelector('.gesture-hint-left');
                const rightHint = activeCardElement.querySelector('.gesture-hint-right');
                if (leftHint) leftHint.classList.remove('visible', 'active');
                if (rightHint) rightHint.classList.remove('visible', 'active');
            } else if (isPinching) {
                // Pinch ended - keep current zoom
                activeCardElement.classList.remove('zooming');
            }
            
            isPanning = false;
            isPinching = false;
            activeCardElement.classList.remove('panning');
            activeCardElement = null;
        }

        function handleTouchCancel(e) {
            if (activeCardElement) {
                resetCardTransform(activeCardElement);
                activeCardElement.classList.remove('panning', 'zooming');
                
                const leftHint = activeCardElement.querySelector('.gesture-hint-left');
                const rightHint = activeCardElement.querySelector('.gesture-hint-right');
                if (leftHint) leftHint.classList.remove('visible', 'active');
                if (rightHint) rightHint.classList.remove('visible', 'active');
            }
            isPanning = false;
            isPinching = false;
            activeCardElement = null;
        }

        function resetCardTransform(card) {
            card.style.transform = 'translateX(0px) scale(1)';
            const cardInner = card.querySelector('.card');
            if (cardInner) cardInner.classList.remove('zoomed');
        }

        // ==================== GESTURE ACTIONS ====================
        const overlay = document.getElementById('gestureOverlay');
        const modal = document.getElementById('gestureModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCancel = document.getElementById('modalCancel');
        const modalConfirm = document.getElementById('modalConfirm');
        
        let currentActionListingId = null;

        function showPingModal(listingId) {
            currentActionListingId = listingId;
            modalTitle.textContent = 'Ask the seller a question';
            modalMessage.placeholder = 'Type your message...';
            overlay.classList.add('visible');
        }

        function saveForLater(listingId) {
            const listing = listings.find(l => l.id === listingId);
            if (listing && !savedItems.includes(listingId)) {
                savedItems.push(listingId);
                localStorage.setItem('freepile_saved', JSON.stringify(savedItems));
                
                // Show visual feedback
                const card = document.querySelector(`[data-listing-id="${listingId}"]`);
                if (card) {
                    const savedBadge = document.createElement('div');
                    savedBadge.className = 'saved-badge';
                    savedBadge.textContent = '‚≠ê Saved';
                    card.querySelector('.card').appendChild(savedBadge);
                    setTimeout(() => savedBadge.remove(), 2000);
                }
                
                alert('‚úÖ Saved for later');
            }
        }

        modalCancel.addEventListener('click', () => {
            overlay.classList.remove('visible');
            modalMessage.value = '';
        });

        modalConfirm.addEventListener('click', () => {
            const message = modalMessage.value.trim();
            if (!message) {
                alert('Please enter a message');
                return;
            }
            
            // In real app, this would send to backend
            console.log('Sending ping for listing:', currentActionListingId, 'message:', message);
            alert('‚úÖ Your message has been sent to the seller');
            
            overlay.classList.remove('visible');
            modalMessage.value = '';
        });

        // ==================== RENDER ====================
        function updateCounts() {
            const ottawaListings = listings.filter(l => l.region === HOME_REGION);
            document.getElementById('freeCount').textContent = ottawaListings.filter(l => l.type === 'free').length;
            document.getElementById('saleCount').textContent = ottawaListings.filter(l => l.type === 'sale').length;
        }

        function renderGrid() {
            const grid = document.getElementById('cardsGrid');
            const filtered = listings.filter(l => l.region === currentRegion && l.type === currentPile);
            
            if (filtered.length === 0) {
                grid.innerHTML = `<div class="empty-state">
                    ‚ú® ${currentPile === 'free' ? 'FREE' : 'FOR SALE'} pile in ${currentRegion} is empty
                    ${currentRegion === HOME_REGION ? '¬∑ snap something!' : '¬∑ try your home pile'}
                </div>`;
                return;
            }

            grid.innerHTML = filtered.map(listing => `
                <div class="card-container" data-listing-id="${listing.id}" style="transform: translateX(0px) scale(1);">
                    <div class="card ${listing.type}">
                        ${savedItems.includes(listing.id) ? '<div class="saved-badge">‚≠ê Saved</div>' : ''}
                        <img src="${listing.image}" class="card-image" alt="${listing.title}">
                        <div class="card-content">
                            <div class="card-title">
                                ${listing.title}
                                <span class="card-price ${listing.type}">
                                    ${listing.type === 'free' ? 'FREE' : '$' + listing.price}
                                </span>
                            </div>
                            <div class="card-meta">
                                <span>@${listing.handle}</span>
                                <span class="card-region">
                                    üìç ${listing.region}
                                    ${listing.region === HOME_REGION ? '¬∑ home' : ''}
                                </span>
                            </div>
                            <div class="ml-badge">ü§ñ ML-suggested</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Setup gesture handlers for new cards
            setupGestureHandlers();
        }

        // Re-setup gesture handlers after any update
        const originalRenderGrid = renderGrid;
        renderGrid = function() {
            originalRenderGrid();
            setupGestureHandlers();
        };
    </script>
</body>
</html>
