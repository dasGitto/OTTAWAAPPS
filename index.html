<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FREEPILE Ottawa ¬∑ snap ¬∑ flick ¬∑ move</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f1f5f9;
            color: #0f172a;
            padding: 1rem;
            overflow-x: hidden;
            height: 100vh;
            overflow: hidden;
            touch-action: pan-y pinch-zoom;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .logo span {
            background: #0f172a;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 40px;
            font-size: 0.8rem;
        }

        .region-badge {
            background: #e62e2e;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 40px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .handle-box {
            background: white;
            padding: 0.3rem 0.6rem;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .handle-box input {
            border: none;
            padding: 0.3rem;
            font-size: 0.85rem;
            width: 100px;
            border-bottom: 2px solid #e2e8f0;
        }

        .handle-box button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin: 0.5rem 0;
            background: white;
            padding: 0.3rem;
            border-radius: 40px;
            width: fit-content;
        }

        .view-btn {
            padding: 0.4rem 1rem;
            border-radius: 40px;
            border: none;
            background: transparent;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.85rem;
        }

        .view-btn.active {
            background: #e62e2e;
            color: white;
        }

        /* Region Selector */
        .region-selector {
            background: white;
            border-radius: 40px;
            padding: 0.3rem;
            display: flex;
            gap: 0.2rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .region-btn {
            padding: 0.3rem 0.8rem;
            border-radius: 40px;
            border: none;
            background: transparent;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .region-btn.active {
            background: #e62e2e;
            color: white;
        }

        /* Upload Card */
        .upload-card {
            background: white;
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            background: #f8fafc;
        }

        .upload-area .icon {
            font-size: 2rem;
        }

        .upload-area .text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        #fileInput {
            display: none;
        }

        /* Preview Section */
        .preview-section {
            margin-top: 0.8rem;
            display: none;
        }

        .preview-section.active {
            display: block;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 0.8rem;
        }

        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .ml-results {
            background: #f8fafc;
            padding: 0.8rem;
            border-radius: 10px;
        }

        .ml-label {
            background: #e62e2e;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 40px;
            font-size: 0.7rem;
            display: inline-block;
            margin-bottom: 0.4rem;
        }

        .ml-field {
            margin-bottom: 0.4rem;
        }

        .ml-field input, .ml-field textarea {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .ml-field textarea {
            height: 50px;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin: 0.4rem 0;
        }

        .tag {
            background: #e2e8f0;
            padding: 0.2rem 0.5rem;
            border-radius: 40px;
            font-size: 0.7rem;
        }

        .pile-buttons {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.4rem;
        }

        .pile-btn {
            flex: 1;
            padding: 0.5rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
        }

        .pile-btn.free {
            background: #dcfce7;
            color: #166534;
            border: 2px solid #86efac;
        }

        .pile-btn.sale {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #fecaca;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 0.5rem;
        }

        /* PILE NAVIGATION - BIG AND CLEAR */
        .pile-nav {
            display: flex;
            gap: 0.5rem;
            margin: 0.8rem 0;
            background: white;
            padding: 0.4rem;
            border-radius: 50px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pile-tab {
            flex: 1;
            padding: 0.8rem 0.5rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            background: transparent;
            border: none;
            transition: all 0.2s;
        }

        .pile-tab.free {
            color: #166534;
            background: #f0fdf4;
        }

        .pile-tab.free.active {
            background: #22c55e;
            color: white;
            box-shadow: 0 4px 12px rgba(34,197,94,0.3);
        }

        .pile-tab.sale {
            color: #991b1b;
            background: #fef2f2;
        }

        .pile-tab.sale.active {
            background: #ef4444;
            color: white;
            box-shadow: 0 4px 12px rgba(239,68,68,0.3);
        }

        .pile-tab .count {
            background: rgba(255,255,255,0.3);
            padding: 0.2rem 0.6rem;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Sorting Bar */
        .sort-bar {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 0.3rem 0.8rem;
            border-radius: 40px;
            border: 1px solid #cbd5e1;
            background: white;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .sort-btn.active {
            background: #e62e2e;
            color: white;
            border-color: #e62e2e;
        }

        /* ===== GRID VIEW ===== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 0.8rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            position: relative;
            transition: transform 0.2s;
        }

        .card.free {
            border-left: 4px solid #22c55e;
        }

        .card.sale {
            border-left: 4px solid #ef4444;
        }

        .card-image {
            width: 100%;
            height: 130px;
            object-fit: cover;
        }

        .card-content {
            padding: 0.6rem;
        }

        .card-title {
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
        }

        .card-price {
            font-weight: 700;
            font-size: 0.85rem;
        }

        .card-price.free {
            color: #22c55e;
        }

        .card-price.sale {
            color: #ef4444;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 0.3rem;
        }

        /* ===== TABLE VIEW ===== */
        .table-view {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .table-view.active {
            display: flex;
        }

        /* Table Pile Nav - Inside table view */
        .table-pile-nav {
            display: flex;
            gap: 0.5rem;
            margin: 0.8rem 0;
            background: white;
            padding: 0.4rem;
            border-radius: 50px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .table-pile-tab {
            flex: 1;
            padding: 0.6rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 40px;
            border: none;
            transition: all 0.2s;
        }

        .table-pile-tab.free {
            background: #f0fdf4;
            color: #166534;
        }

        .table-pile-tab.free.active {
            background: #22c55e;
            color: white;
        }

        .table-pile-tab.sale {
            background: #fef2f2;
            color: #991b1b;
        }

        .table-pile-tab.sale.active {
            background: #ef4444;
            color: white;
        }

        .table-pile-tab.all {
            background: #f1f5f9;
            color: #334155;
        }

        .table-pile-tab.all.active {
            background: #334155;
            color: white;
        }

        .table-surface {
            flex: 1;
            background: #2d4a3e;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            min-height: 400px;
            touch-action: none;
            margin-bottom: 0.8rem;
        }

        .table-card {
            position: absolute;
            width: 130px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            cursor: grab;
            user-select: none;
            touch-action: none;
            transition: box-shadow 0.2s;
            overflow: hidden;
        }

        .table-card.dragging {
            opacity: 0.9;
            box-shadow: 0 12px 24px rgba(0,0,0,0.6);
            z-index: 1000;
        }

        .table-card .card-photo {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        .table-card .card-info {
            padding: 0.4rem;
        }

        .table-card .card-title {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .table-card .card-price {
            font-size: 0.8rem;
            font-weight: 700;
        }

        .table-card .card-price.free {
            color: #22c55e;
        }

        .table-card .card-price.sale {
            color: #ef4444;
        }

        /* Drop Zones */
        .drop-zones {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.4rem;
            margin-top: 0.4rem;
        }

        .drop-zone {
            padding: 0.6rem 0.2rem;
            border-radius: 30px;
            background: rgba(255,255,255,0.9);
            border: 2px dashed #94a3b8;
            text-align: center;
            font-weight: 600;
            font-size: 0.7rem;
            transition: all 0.2s;
            pointer-events: none;
            opacity: 0.7;
        }

        .drop-zone.visible {
            pointer-events: auto;
            opacity: 1;
        }

        .drop-zone.drag-over {
            transform: scale(1.05);
            background: white;
            border-color: #e62e2e;
        }

        .drop-zone.free {
            border-color: #22c55e;
            color: #166534;
        }

        .drop-zone.sale {
            border-color: #ef4444;
            color: #991b1b;
        }

        .drop-zone.ask {
            border-color: #3b82f6;
            color: #1e40af;
        }

        .drop-zone.report {
            border-color: #ef4444;
            color: #7f1d1d;
        }

        /* Gesture Hints */
        .gesture-hint-left, .gesture-hint-right {
            position: absolute;
            top: 0;
            height: 100%;
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 5;
        }

        .gesture-hint-left {
            left: 0;
            background: linear-gradient(90deg, #3b82f6 0%, transparent 100%);
            color: white;
            border-radius: 12px 0 0 12px;
        }

        .gesture-hint-right {
            right: 0;
            background: linear-gradient(270deg, #8b5cf6 0%, transparent 100%);
            color: white;
            border-radius: 0 12px 12px 0;
        }

        .gesture-hint-left.visible, .gesture-hint-right.visible {
            opacity: 1;
        }

        .gesture-hint-left.active {
            background: #2563eb;
        }

        .gesture-hint-right.active {
            background: #7c3aed;
        }

        .saved-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #8b5cf6;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 40px;
            font-size: 0.6rem;
            z-index: 10;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
            grid-column: 1 / -1;
        }

        /* Gesture Action Overlay */
        .gesture-action-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .gesture-action-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .gesture-action-modal {
            background: white;
            padding: 1.2rem;
            border-radius: 20px;
            max-width: 320px;
            width: 90%;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
        }

        .modal-input {
            width: 100%;
            padding: 0.6rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin: 0.8rem 0;
            font-size: 0.9rem;
        }

        .modal-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.6rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .modal-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .modal-btn.secondary {
            background: #e2e8f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                FREEPILE <span>Œ±</span>
                <div class="region-badge">üìç Ottawa</div>
            </div>
            <div class="handle-box">
                <input type="text" id="handleInput" placeholder="handle">
                <button id="saveHandle">save</button>
            </div>
        </div>

        <!-- Region Selector -->
        <div class="region-selector">
            <button class="region-btn ottawa active" id="regionOttawa">üìç Ottawa</button>
            <button class="region-btn" id="regionMontreal">Montreal</button>
            <button class="region-btn" id="regionToronto">Toronto</button>
            <button class="region-btn" id="regionVancouver">Vancouver</button>
        </div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="view-btn active" id="viewGrid">üì± Grid</button>
            <button class="view-btn" id="viewTable">üóÉÔ∏è Table</button>
        </div>

        <!-- Upload Card -->
        <div class="upload-card">
            <div class="upload-area" id="uploadArea">
                <div class="icon">üì∏</div>
                <div class="text">tap to take photo</div>
            </div>
            <input type="file" id="fileInput" accept="image/*" capture="environment">

            <div class="preview-section" id="previewSection">
                <div class="preview-grid">
                    <img id="previewImage" class="preview-image" src="">
                    <div class="ml-results">
                        <div class="ml-label" id="mlStatus">ü§ñ analyzing...</div>
                        <div class="ml-field">
                            <input type="text" id="mlTitle" placeholder="title">
                        </div>
                        <div class="ml-field">
                            <textarea id="mlDescription" placeholder="description"></textarea>
                        </div>
                        <div class="tag-list" id="tagList"></div>
                        <div class="pile-buttons">
                            <button class="pile-btn free" id="dropFree">üÜì FREE</button>
                            <button class="pile-btn sale" id="dropSale">üí∞ SALE</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content" id="mainContent">
            <!-- GRID VIEW -->
            <div id="gridView">
                <!-- CLEAR PILE NAVIGATION -->
                <div class="pile-nav">
                    <button class="pile-tab free active" id="tabFree">
                        üÜì FREE PILE <span class="count" id="freeCount">0</span>
                    </button>
                    <button class="pile-tab sale" id="tabSale">
                        üí∞ SALE PILE <span class="count" id="saleCount">0</span>
                    </button>
                </div>

                <!-- Sorting -->
                <div class="sort-bar">
                    <button class="sort-btn active" data-sort="newest">üïê Newest</button>
                    <button class="sort-btn" data-sort="price-low">üí∞ Low</button>
                    <button class="sort-btn" data-sort="price-high">üí∞ High</button>
                </div>

                <!-- Cards Grid -->
                <div class="cards-grid" id="cardsGrid"></div>
            </div>

            <!-- TABLE VIEW -->
            <div id="tableView" class="table-view">
                <!-- TABLE VIEW PILE NAVIGATION -->
                <div class="table-pile-nav">
                    <button class="table-pile-tab free active" id="tableTabFree">üÜì FREE</button>
                    <button class="table-pile-tab sale" id="tableTabSale">üí∞ SALE</button>
                    <button class="table-pile-tab all" id="tableTabAll">üìã ALL</button>
                </div>

                <!-- Table Surface for movable cards -->
                <div class="table-surface" id="tableSurface"></div>
                
                <!-- Drop Zones -->
                <div class="drop-zones" id="dropZones">
                    <div class="drop-zone free" data-action="free">üÜì FREE</div>
                    <div class="drop-zone sale" data-action="sale">üí∞ SALE</div>
                    <div class="drop-zone ask" data-action="ask">‚ùì ASK</div>
                    <div class="drop-zone report" data-action="report">‚ö†Ô∏è REPORT</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gesture Action Overlay -->
    <div class="gesture-action-overlay" id="gestureOverlay">
        <div class="gesture-action-modal">
            <div class="modal-title" id="modalTitle">Ask a question</div>
            <textarea id="modalMessage" class="modal-input" placeholder="Type your message..." rows="3"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="modalCancel">Cancel</button>
                <button class="modal-btn primary" id="modalConfirm">Send</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIG ====================
        const HOME_REGION = 'ottawa';
        const HF_TOKEN = 'hf_YOUR_TOKEN_HERE';

        // ==================== STATE ====================
        let currentHandle = localStorage.getItem('freepile_handle') || '';
        let currentRegion = localStorage.getItem('freepile_current_region') || HOME_REGION;
        let currentPile = 'free';
        let currentTablePile = 'free'; // Separate for table view
        let currentView = 'grid';
        let currentSort = 'newest';
        let listings = JSON.parse(localStorage.getItem('freepile_listings') || '[]');
        let savedItems = JSON.parse(localStorage.getItem('freepile_saved') || '[]');
        let currentMLResult = null;

        // Drag state
        let draggedCard = null;
        let draggedCardElement = null;
        let dragOffsetX = 0, dragOffsetY = 0;
        let isDragging = false;

        // Gesture state
        let activeCard = null;
        let startX = 0;
        let currentTranslateX = 0;
        let touchStartTime = 0;

        // ==================== INIT ====================
        document.getElementById('handleInput').value = currentHandle;
        if (currentHandle) {
            document.getElementById('saveHandle').textContent = '‚úì';
        }

        // Sample listings
        if (listings.length === 0) {
            listings = [
                { id: '1', handle: 'alex', type: 'free', title: 'Plant', price: null, image: 'https://images.unsplash.com/photo-1493663284031-b7e3aefcae8e?w=200', timestamp: Date.now() - 3600000, region: 'ottawa' },
                { id: '2', handle: 'sam', type: 'sale', title: 'Camera Lens', price: 120, image: 'https://images.unsplash.com/photo-1502920917122-7aa1b5f8a1e0?w=200', timestamp: Date.now() - 7200000, region: 'ottawa' },
                { id: '3', handle: 'jordan', type: 'free', title: 'Books', price: null, image: 'https://images.unsplash.com/photo-1495446815901-a7297e633e8d?w=200', timestamp: Date.now() - 86400000, region: 'ottawa' },
                { id: '4', handle: 'taylor', type: 'sale', title: 'Chair', price: 45, image: 'https://images.unsplash.com/photo-1505843490538-5133c6c7d0e1?w=200', timestamp: Date.now() - 172800000, region: 'ottawa' }
            ];
            localStorage.setItem('freepile_listings', JSON.stringify(listings));
        }

        updateCounts();
        renderGrid();

        // ==================== VIEW TOGGLE ====================
        document.getElementById('viewGrid').addEventListener('click', () => {
            currentView = 'grid';
            document.getElementById('viewGrid').classList.add('active');
            document.getElementById('viewTable').classList.remove('active');
            document.getElementById('gridView').style.display = 'block';
            document.getElementById('tableView').classList.remove('active');
            renderGrid();
        });

        document.getElementById('viewTable').addEventListener('click', () => {
            currentView = 'table';
            document.getElementById('viewTable').classList.add('active');
            document.getElementById('viewGrid').classList.remove('active');
            document.getElementById('gridView').style.display = 'none';
            document.getElementById('tableView').classList.add('active');
            renderTable();
        });

        // ==================== GRID PILE NAVIGATION ====================
        document.getElementById('tabFree').addEventListener('click', () => {
            currentPile = 'free';
            document.getElementById('tabFree').classList.add('active');
            document.getElementById('tabSale').classList.remove('active');
            renderGrid();
        });

        document.getElementById('tabSale').addEventListener('click', () => {
            currentPile = 'sale';
            document.getElementById('tabSale').classList.add('active');
            document.getElementById('tabFree').classList.remove('active');
            renderGrid();
        });

        // ==================== TABLE PILE NAVIGATION ====================
        document.getElementById('tableTabFree').addEventListener('click', () => {
            currentTablePile = 'free';
            document.getElementById('tableTabFree').classList.add('active');
            document.getElementById('tableTabSale').classList.remove('active');
            document.getElementById('tableTabAll').classList.remove('active');
            renderTable();
        });

        document.getElementById('tableTabSale').addEventListener('click', () => {
            currentTablePile = 'sale';
            document.getElementById('tableTabSale').classList.add('active');
            document.getElementById('tableTabFree').classList.remove('active');
            document.getElementById('tableTabAll').classList.remove('active');
            renderTable();
        });

        document.getElementById('tableTabAll').addEventListener('click', () => {
            currentTablePile = 'all';
            document.getElementById('tableTabAll').classList.add('active');
            document.getElementById('tableTabFree').classList.remove('active');
            document.getElementById('tableTabSale').classList.remove('active');
            renderTable();
        });

        // ==================== SORTING ====================
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSort = btn.dataset.sort;
                renderGrid();
            });
        });

        // ==================== REGION ====================
        document.getElementById('regionOttawa').addEventListener('click', () => setRegion('ottawa'));
        document.getElementById('regionMontreal').addEventListener('click', () => setRegion('montreal'));
        document.getElementById('regionToronto').addEventListener('click', () => setRegion('toronto'));
        document.getElementById('regionVancouver').addEventListener('click', () => setRegion('vancouver'));

        function setRegion(region) {
            currentRegion = region;
            localStorage.setItem('freepile_current_region', region);
            document.querySelectorAll('.region-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`region${region.charAt(0).toUpperCase() + region.slice(1)}`).classList.add('active');
            if (currentView === 'grid') renderGrid();
            else renderTable();
        }

        // ==================== HANDLE ====================
        document.getElementById('saveHandle').addEventListener('click', () => {
            const handle = document.getElementById('handleInput').value.trim();
            if (handle && handle.match(/^[a-zA-Z0-9_]{3,20}$/)) {
                currentHandle = handle;
                localStorage.setItem('freepile_handle', handle);
                document.getElementById('saveHandle').textContent = '‚úì';
            } else {
                alert('handle must be 3-20 chars');
            }
        });

        // ==================== UPLOAD ====================
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => document.getElementById('previewImage').src = e.target.result;
            reader.readAsDataURL(file);

            await runMockML(file);
        });

        async function runMockML(file) {
            document.getElementById('previewSection').classList.add('active');
            document.getElementById('mlStatus').innerHTML = 'ü§ñ analyzing...';
            
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const fileName = file.name.toLowerCase();
            let title = '', tags = [];
            
            if (fileName.includes('camera') || fileName.includes('lens')) {
                title = 'Camera Lens'; tags = ['photography', 'camera'];
            } else if (fileName.includes('chair') || fileName.includes('sofa')) {
                title = 'Chair'; tags = ['furniture'];
            } else if (fileName.includes('book')) {
                title = 'Books'; tags = ['books'];
            } else {
                title = 'Item'; tags = ['misc'];
            }
            
            document.getElementById('mlTitle').value = title;
            document.getElementById('mlDescription').value = 'Great condition, ready for new home';
            document.getElementById('tagList').innerHTML = tags.map(t => `<span class="tag">#${t}</span>`).join('');
            document.getElementById('mlStatus').innerHTML = 'ü§ñ ready ‚Äî edit if needed';
            
            currentMLResult = { title, tags };
        }

        // ==================== DROP INTO PILES ====================
        document.getElementById('dropFree').addEventListener('click', () => dropIntoPile('free'));
        document.getElementById('dropSale').addEventListener('click', () => {
            const price = prompt('Price?', '20');
            if (price) dropIntoPile('sale', parseFloat(price));
        });

        function dropIntoPile(type, price = null) {
            if (!currentHandle) return alert('set a handle first');
            if (!currentMLResult) return alert('take a photo first');
            if (currentRegion !== HOME_REGION) return alert('only post in Ottawa');

            const listing = {
                id: 'l_' + Date.now() + '_' + Math.random().toString(36).substring(2, 7),
                handle: currentHandle,
                type: type,
                title: document.getElementById('mlTitle').value,
                price: type === 'sale' ? price : null,
                image: document.getElementById('previewImage').src,
                timestamp: Date.now(),
                region: HOME_REGION
            };

            listings.unshift(listing);
            localStorage.setItem('freepile_listings', JSON.stringify(listings));

            document.getElementById('previewSection').classList.remove('active');
            document.getElementById('fileInput').value = '';
            currentMLResult = null;
            
            updateCounts();
            if (currentView === 'grid') renderGrid();
            else renderTable();
            
            alert(`‚úÖ added to ${type} pile`);
        }

        // ==================== UPDATE COUNTS ====================
        function updateCounts() {
            const ottawaListings = listings.filter(l => l.region === HOME_REGION);
            document.getElementById('freeCount').textContent = ottawaListings.filter(l => l.type === 'free').length;
            document.getElementById('saleCount').textContent = ottawaListings.filter(l => l.type === 'sale').length;
        }

        // ==================== RENDER GRID ====================
        function renderGrid() {
            const grid = document.getElementById('cardsGrid');
            
            let filtered = listings.filter(l => l.region === currentRegion && l.type === currentPile);
            
            if (currentSort === 'newest') {
                filtered.sort((a, b) => b.timestamp - a.timestamp);
            } else if (currentSort === 'price-low') {
                filtered.sort((a, b) => (a.price || 0) - (b.price || 0));
            } else if (currentSort === 'price-high') {
                filtered.sort((a, b) => (b.price || 0) - (a.price || 0));
            }
            
            if (filtered.length === 0) {
                grid.innerHTML = `<div class="empty-state">‚ú® No ${currentPile} items in ${currentRegion}</div>`;
                return;
            }

            grid.innerHTML = filtered.map(listing => `
                <div class="card ${listing.type}" data-id="${listing.id}" style="position: relative;">
                    ${savedItems.includes(listing.id) ? '<div class="saved-badge">‚≠ê Saved</div>' : ''}
                    <img src="${listing.image}" class="card-image" loading="lazy">
                    <div class="card-content">
                        <div class="card-title">
                            <span>${listing.title.substring(0, 15)}</span>
                            <span class="card-price ${listing.type}">
                                ${listing.type === 'free' ? 'FREE' : '$' + listing.price}
                            </span>
                        </div>
                        <div class="card-meta">
                            <span>@${listing.handle}</span>
                            <span>üìç ${listing.region}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            setupGridGestures();
        }

        // ==================== RENDER TABLE ====================
        function renderTable() {
            const surface = document.getElementById('tableSurface');
            
            // Filter by region AND pile selection
            let filtered = listings.filter(l => l.region === currentRegion);
            
            if (currentTablePile !== 'all') {
                filtered = filtered.filter(l => l.type === currentTablePile);
            }
            
            if (filtered.length === 0) {
                surface.innerHTML = '<div style="color:white; text-align:center; padding:2rem;">‚ú® No items in this view</div>';
                return;
            }

            surface.innerHTML = '';

            filtered.forEach((item, i) => {
                const x = 20 + Math.random() * (surface.offsetWidth - 150);
                const y = 40 + Math.random() * (surface.offsetHeight - 180);
                const rot = (Math.random() - 0.5) * 8;
                
                const card = document.createElement('div');
                card.className = `table-card ${item.type}`;
                card.id = `table_${item.id}`;
                card.dataset.id = item.id;
                card.style.left = x + 'px';
                card.style.top = y + 'px';
                card.style.transform = `rotate(${rot}deg)`;
                card.style.zIndex = i + 1;
                
                card.innerHTML = `
                    <img class="card-photo" src="${item.image}" loading="lazy">
                    <div class="card-info">
                        <div class="card-title">${item.title.substring(0, 12)}</div>
                        <div class="card-price ${item.type}">${item.type === 'free' ? 'FREE' : '$' + item.price}</div>
                    </div>
                `;

                card.addEventListener('mousedown', (e) => startTableDrag(e, item.id));
                card.addEventListener('touchstart', (e) => startTableDrag(e, item.id));

                surface.appendChild(card);
            });

            document.querySelectorAll('.drop-zone').forEach(z => z.classList.add('visible'));
        }

        // ==================== TABLE DRAG ====================
        function startTableDrag(e, id) {
            e.preventDefault();
            
            const card = document.getElementById('table_' + id);
            if (!card) return;

            const pos = getEventPos(e);
            const rect = card.getBoundingClientRect();
            const surfaceRect = document.getElementById('tableSurface').getBoundingClientRect();

            draggedCard = id;
            draggedCardElement = card;
            dragOffsetX = pos.x - rect.left;
            dragOffsetY = pos.y - rect.top;
            
            card.classList.add('dragging');
            isDragging = false;

            document.addEventListener('mousemove', onTableDragMove);
            document.addEventListener('touchmove', onTableDragMove, { passive: false });
            document.addEventListener('mouseup', onTableDragEnd);
            document.addEventListener('touchend', onTableDragEnd);
        }

        function onTableDragMove(e) {
            e.preventDefault();
            if (!draggedCardElement) return;

            const pos = getEventPos(e);
            const surfaceRect = document.getElementById('tableSurface').getBoundingClientRect();
            
            let x = pos.x - surfaceRect.left - dragOffsetX;
            let y = pos.y - surfaceRect.top - dragOffsetY;
            
            x = Math.max(5, Math.min(x, surfaceRect.width - 140));
            y = Math.max(5, Math.min(y, surfaceRect.height - 140));
            
            draggedCardElement.style.left = x + 'px';
            draggedCardElement.style.top = y + 'px';
            
            checkTableDropZones(pos);
            isDragging = true;
        }

        function onTableDragEnd(e) {
            if (!draggedCardElement) return;

            const pos = getEventPos(e);
            const dropZone = checkTableDropZones(pos, true);

            if (dropZone && isDragging) {
                const action = dropZone.dataset.action;
                const item = listings.find(l => l.id === draggedCard);

                if (item) {
                    switch(action) {
                        case 'free':
                            if (item.type !== 'free') {
                                item.type = 'free';
                                item.price = null;
                                alert('üÜì Moved to FREE pile');
                            }
                            break;
                        case 'sale':
                            if (item.type !== 'sale') {
                                const price = prompt('Price:', '20');
                                if (price) {
                                    item.type = 'sale';
                                    item.price = parseFloat(price);
                                    alert('üí∞ Moved to SALE pile');
                                }
                            }
                            break;
                        case 'ask':
                            showPingModal(item.id);
                            break;
                        case 'report':
                            if (confirm('Report this item?')) {
                                listings = listings.filter(l => l.id !== item.id);
                                alert('‚ö†Ô∏è Reported');
                            }
                            break;
                    }

                    if (action === 'free' || action === 'sale') {
                        localStorage.setItem('freepile_listings', JSON.stringify(listings));
                        updateCounts();
                        renderTable();
                    }
                }
            }

            draggedCardElement.classList.remove('dragging');
            document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('drag-over'));
            
            document.removeEventListener('mousemove', onTableDragMove);
            document.removeEventListener('touchmove', onTableDragMove);
            document.removeEventListener('mouseup', onTableDragEnd);
            document.removeEventListener('touchend', onTableDragEnd);
            
            draggedCard = null;
            draggedCardElement = null;
            isDragging = false;
        }

        function checkTableDropZones(pos, returnZone = false) {
            const zones = document.querySelectorAll('.drop-zone');
            let overZone = null;

            zones.forEach(zone => {
                const rect = zone.getBoundingClientRect();
                if (pos.x >= rect.left && pos.x <= rect.right &&
                    pos.y >= rect.top && pos.y <= rect.bottom) {
                    zone.classList.add('drag-over');
                    overZone = zone;
                } else {
                    zone.classList.remove('drag-over');
                }
            });

            return returnZone ? overZone : null;
        }

        // ==================== GRID GESTURES ====================
        function setupGridGestures() {
            document.querySelectorAll('.card').forEach(card => {
                if (card.querySelector('.gesture-hint-left')) return;
                
                const leftHint = document.createElement('div');
                leftHint.className = 'gesture-hint-left';
                leftHint.innerHTML = '‚Üê PING';
                card.appendChild(leftHint);
                
                const rightHint = document.createElement('div');
                rightHint.className = 'gesture-hint-right';
                rightHint.innerHTML = 'SAVE ‚Üí';
                card.appendChild(rightHint);
                
                card.addEventListener('touchstart', handleGridTouchStart);
                card.addEventListener('touchmove', handleGridTouchMove, { passive: false });
                card.addEventListener('touchend', handleGridTouchEnd);
            });
        }

        function handleGridTouchStart(e) {
            e.preventDefault();
            activeCard = this;
            const touch = e.touches[0];
            startX = touch.clientX;
            touchStartTime = Date.now();
            currentTranslateX = 0;
            
            this.querySelector('.gesture-hint-left').classList.add('visible');
            this.querySelector('.gesture-hint-right').classList.add('visible');
        }

        function handleGridTouchMove(e) {
            e.preventDefault();
            if (!activeCard) return;
            
            const touch = e.touches[0];
            const deltaX = touch.clientX - startX;
            
            currentTranslateX = Math.max(-80, Math.min(80, deltaX));
            activeCard.style.transform = `translateX(${currentTranslateX}px)`;
            
            const leftHint = activeCard.querySelector('.gesture-hint-left');
            const rightHint = activeCard.querySelector('.gesture-hint-right');
            
            if (currentTranslateX < -30) {
                leftHint.classList.add('active');
                rightHint.classList.remove('active');
            } else if (currentTranslateX > 30) {
                rightHint.classList.add('active');
                leftHint.classList.remove('active');
            } else {
                leftHint.classList.remove('active');
                rightHint.classList.remove('active');
            }
        }

        function handleGridTouchEnd(e) {
            e.preventDefault();
            if (!activeCard) return;
            
            const timeElapsed = Date.now() - touchStartTime;
            const isFlick = timeElapsed < 300 && Math.abs(currentTranslateX) > 20;
            const listingId = activeCard.dataset.id;
            
            if (currentTranslateX < -40 || (isFlick && currentTranslateX < -20)) {
                showPingModal(listingId);
            } else if (currentTranslateX > 40 || (isFlick && currentTranslateX > 20)) {
                saveForLater(listingId);
            }
            
            activeCard.style.transform = '';
            activeCard.querySelector('.gesture-hint-left').classList.remove('visible', 'active');
            activeCard.querySelector('.gesture-hint-right').classList.remove('visible', 'active');
            activeCard = null;
        }

        // ==================== GESTURE ACTIONS ====================
        const overlay = document.getElementById('gestureOverlay');
        const modalMessage = document.getElementById('modalMessage');
        const modalCancel = document.getElementById('modalCancel');
        const modalConfirm = document.getElementById('modalConfirm');
        let currentActionId = null;

        function showPingModal(listingId) {
            currentActionId = listingId;
            document.getElementById('modalTitle').textContent = 'Message seller';
            overlay.classList.add('visible');
        }

        function saveForLater(listingId) {
            if (!savedItems.includes(listingId)) {
                savedItems.push(listingId);
                localStorage.setItem('freepile_saved', JSON.stringify(savedItems));
                alert('‚úÖ Saved');
            }
        }

        modalCancel.addEventListener('click', () => {
            overlay.classList.remove('visible');
            modalMessage.value = '';
        });

        modalConfirm.addEventListener('click', () => {
            const msg = modalMessage.value.trim();
            if (!msg) return alert('Enter a message');
            
            const listing = listings.find(l => l.id === currentActionId);
            if (listing) {
                alert(`‚úÖ Message sent to ${listing.handle}`);
            }
            
            overlay.classList.remove('visible');
            modalMessage.value = '';
        });

        function getEventPos(e) {
            if (e.touches) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            return { x: e.clientX, y: e.clientY };
        }
    </script>
</body>
</html>
